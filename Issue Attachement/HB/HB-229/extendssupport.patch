Index: net/sf/hibernate/hibernate-mapping-2.0.dtd
===================================================================
RCS file: /cvsroot/hibernate/Hibernate2/src/net/sf/hibernate/hibernate-mapping-2.0.dtd,v
retrieving revision 1.34.2.7
diff -u -r1.34.2.7 hibernate-mapping-2.0.dtd
--- net/sf/hibernate/hibernate-mapping-2.0.dtd	10 Aug 2003 16:51:41 -0000	1.34.2.7
+++ net/sf/hibernate/hibernate-mapping-2.0.dtd	21 Aug 2003 10:12:19 -0000
@@ -18,7 +18,7 @@
 
 <!-- The document root. -->
 
-<!ELEMENT hibernate-mapping (meta*, import*, class*, query*)>
+<!ELEMENT hibernate-mapping (meta*, import*, (class|subclass|joined-subclass)*, query*)>
   <!ATTLIST hibernate-mapping schema CDATA #IMPLIED>                            <!-- default: none -->
   <!ATTLIST hibernate-mapping default-cascade (none|save-update|all) "none">
   <!ATTLIST hibernate-mapping auto-import (true|false) "true">
@@ -109,6 +109,7 @@
   <!ATTLIST subclass discriminator-value CDATA #IMPLIED>  <!-- default: unqualified class name | none -->
   <!ATTLIST subclass dynamic-update (true|false) "false">
   <!ATTLIST subclass dynamic-insert (true|false) "false">
+  <!ATTLIST subclass extends CDATA #IMPLIED>              <!-- default: empty when a toplevel, otherwise the nearest class definition -->
 
 <!-- Joined subclasses are used for the normalized table-per-subclass mapping strategy -->
 
@@ -124,6 +125,7 @@
   <!ATTLIST joined-subclass schema CDATA #IMPLIED>
   <!ATTLIST joined-subclass dynamic-update (true|false) "false">
   <!ATTLIST joined-subclass dynamic-insert (true|false) "false">
+  <!ATTLIST joined-subclass extends CDATA #IMPLIED>       <!-- default: empty when a toplevel, otherwise the nearest class definition -->
   
 <!-- Property of an entity class or component, component-element, composite-id, etc. 
 JavaBeans style properties are mapped to table columns. -->
Index: net/sf/hibernate/cfg/Binder.java
===================================================================
RCS file: /cvsroot/hibernate/Hibernate2/src/net/sf/hibernate/cfg/Binder.java,v
retrieving revision 1.26.2.12
diff -u -r1.26.2.12 Binder.java
--- net/sf/hibernate/cfg/Binder.java	20 Aug 2003 14:33:14 -0000	1.26.2.12
+++ net/sf/hibernate/cfg/Binder.java	21 Aug 2003 10:12:37 -0000
@@ -916,16 +916,10 @@
 				bindComponent(subnode, (Component) value, reflectedClass, subpath, true, mappings);
 			}
 			else if ( "subclass".equals(name) ) {
-				Subclass subclass = new Subclass(model);
-				bindSubclass( subnode, subclass, mappings );
-				model.addSubclass(subclass);
-				mappings.addClass(subclass);
+				handleSubclass(model, mappings, subnode);
 			}
 			else if ( "joined-subclass".equals(name) ) {
-				Subclass subclass = new Subclass(model);
-				bindJoinedSubclass( subnode, subclass, mappings );
-				model.addSubclass(subclass);
-				mappings.addClass(subclass);
+				handleJoinedSubclass(model, mappings, subnode);
 			}
 			if ( value!=null) {
 				value.setTypeByReflection( model.getPersistentClass(), propertyName );
@@ -937,6 +931,20 @@
 		}
 	}
 
+	private static void handleJoinedSubclass(PersistentClass model, Mappings mappings, Element subnode) throws MappingException {
+		Subclass subclass = new Subclass(model);
+		bindJoinedSubclass( subnode, subclass, mappings );
+		model.addSubclass(subclass);
+		mappings.addClass(subclass);
+	}
+
+	private static void handleSubclass(PersistentClass model, Mappings mappings, Element subnode) throws MappingException {
+		Subclass subclass = new Subclass(model);
+		bindSubclass( subnode, subclass, mappings );
+		model.addSubclass(subclass);
+		mappings.addClass(subclass);
+	}
+
 	public static void bindSetSecondPass(Element node, Set model, java.util.Map persistentClasses, Mappings mappings) throws MappingException {
 
 		bindCollectionSecondPass(node, model, persistentClasses, mappings);
@@ -1099,7 +1107,22 @@
 			Binder.bindRootClass(n, rootclass, model);
 			model.addClass(rootclass);
 		}
-
+		
+		Iterator subclassnodes = hmNode.elementIterator("subclass");
+			while ( subclassnodes.hasNext() ) {
+				Element subnode = (Element) subclassnodes.next();
+				PersistentClass superModel = getSuperclass(model, subnode);
+				handleSubclass(superModel, model, subnode);
+			}
+		
+		Iterator joinedsubclassnodes = hmNode.elementIterator("joined-subclass");
+			while (joinedsubclassnodes.hasNext()) {
+				Element subnode = (Element) joinedsubclassnodes.next();
+				PersistentClass superModel = getSuperclass(model, subnode);
+				handleJoinedSubclass(superModel, model, subnode);
+			}
+		
+		
 		nodes = hmNode.elementIterator("query");
 		while ( nodes.hasNext() ) {
 			Element n = (Element) nodes.next();
@@ -1118,6 +1141,22 @@
 			log.debug("Import: " + rename + " -> " + className);
 			model.addImport(className, rename);
 		}
+	}
+
+	private static PersistentClass getSuperclass(Mappings model, Element subnode) throws MappingException {
+		String extendsValue = subnode.attributeValue("extends");
+		Class superclass;
+		try {
+			superclass = ReflectHelper.classForName(extendsValue);
+		} catch (ClassNotFoundException e) {
+			throw new MappingException("extends class " + extendsValue + " not found.",e);
+		}
+		PersistentClass superModel = model.getClass(superclass);
+			
+		if (superModel==null) {
+			throw new MappingException("Cannot extend unmapped class " + superclass.getName());
+		}
+		return superModel;
 	}
 
 	private static String getPropertyName(Element node) {
Index: net/sf/hibernate/test/ABC.hbm.xml
===================================================================
RCS file: /cvsroot/hibernate/Hibernate2/src/net/sf/hibernate/test/ABC.hbm.xml,v
retrieving revision 1.7
diff -u -r1.7 ABC.hbm.xml
--- net/sf/hibernate/test/ABC.hbm.xml	17 Jun 2003 09:36:38 -0000	1.7
+++ net/sf/hibernate/test/ABC.hbm.xml	21 Aug 2003 10:13:03 -0000
@@ -14,9 +14,6 @@
 				<property name="address" column="c1"/>
 				<one-to-one name="d"/>
 			</subclass>
-			<subclass name="net.sf.hibernate.test.C2" discriminator-value="2">
-				<property name="address" column="c2"/>
-			</subclass>
 		</subclass>
 	</class>
 
Index: net/sf/hibernate/test/ABCTest.java
===================================================================
RCS file: /cvsroot/hibernate/Hibernate2/src/net/sf/hibernate/test/ABCTest.java,v
retrieving revision 1.5.2.1
diff -u -r1.5.2.1 ABCTest.java
--- net/sf/hibernate/test/ABCTest.java	8 Aug 2003 06:16:16 -0000	1.5.2.1
+++ net/sf/hibernate/test/ABCTest.java	21 Aug 2003 10:13:03 -0000
@@ -77,7 +77,7 @@
 	
 	public static Test suite() throws Exception {
 		try {
-			TestCase.buildSessionFactory( new String[] {  "ABC.hbm.xml" } );
+			TestCase.buildSessionFactory( new String[] {  "ABC.hbm.xml", "ABCExtends.hbm.xml"} );
 			return new TestSuite(ABCTest.class);
 		}
 		catch (Exception e) {
Index: net/sf/hibernate/test/Multi.hbm.xml
===================================================================
RCS file: /cvsroot/hibernate/Hibernate2/src/net/sf/hibernate/test/Multi.hbm.xml,v
retrieving revision 1.12.2.3
diff -u -r1.12.2.3 Multi.hbm.xml
--- net/sf/hibernate/test/Multi.hbm.xml	13 Aug 2003 09:37:08 -0000	1.12.2.3
+++ net/sf/hibernate/test/Multi.hbm.xml	21 Aug 2003 10:13:05 -0000
@@ -16,19 +16,7 @@
         <property name="name"/>
         <property name="address"/>
         <property name="date" column="date_"/>
-        
-        <joined-subclass 
-        	name="net.sf.hibernate.test.Mono" 
-        	table="mono"
-        	dynamic-insert="true" 
-    		dynamic-update="true">
-        	<key column="superid"/>
-        	<set name="strings" table="monostrings">
-        		<key column="monoid_"/>
-        		<element type="string" column="str_"/>
-        	</set>
-        </joined-subclass>
-        
+                
         <joined-subclass name="net.sf.hibernate.test.TrivialClass">
         	<key column="tcid"/>
         </joined-subclass>
Index: net/sf/hibernate/test/MultiTableTest.java
===================================================================
RCS file: /cvsroot/hibernate/Hibernate2/src/net/sf/hibernate/test/MultiTableTest.java,v
retrieving revision 1.18.2.5
diff -u -r1.18.2.5 MultiTableTest.java
--- net/sf/hibernate/test/MultiTableTest.java	13 Aug 2003 09:37:08 -0000	1.18.2.5
+++ net/sf/hibernate/test/MultiTableTest.java	21 Aug 2003 10:13:06 -0000
@@ -637,7 +637,7 @@
 	public static Test suite() throws Exception {
 		try {
 			TestCase.buildSessionFactory(
-				new String[] { "Multi.hbm.xml" }
+				new String[] { "Multi.hbm.xml", "MultiExtends.hbm.xml" }
 			);
 		}
 		catch (Exception e) {
Index: src/net/sf/hibernate/test/ABCExtends.hbm.xml
===================================================================
RCS file: src/net/sf/hibernate/test/ABCExtends.hbm.xml
diff -N src/net/sf/hibernate/test/ABCExtends.hbm.xml
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ src/net/sf/hibernate/test/ABCExtends.hbm.xml	1 Jan 1970 00:00:00 -0000
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<!DOCTYPE hibernate-mapping SYSTEM "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd" >
+<hibernate-mapping>
+
+	<subclass name="net.sf.hibernate.test.C2" discriminator-value="2" extends="net.sf.hibernate.test.B">
+		<property name="address" column="c2"/>
+	</subclass>
+
+	
+</hibernate-mapping>
Index: src/net/sf/hibernate/test/MultiExtends.hbm.xml
===================================================================
RCS file: src/net/sf/hibernate/test/MultiExtends.hbm.xml
diff -N src/net/sf/hibernate/test/MultiExtends.hbm.xml
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ src/net/sf/hibernate/test/MultiExtends.hbm.xml	1 Jan 1970 00:00:00 -0000
@@ -0,0 +1,19 @@
+<?xml version="1.0"?>
+<!DOCTYPE hibernate-mapping SYSTEM "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd" >
+<hibernate-mapping>
+
+        <joined-subclass 
+        	name="net.sf.hibernate.test.Mono" 
+        	extends="net.sf.hibernate.test.Top"
+        	table="mono"
+        	dynamic-insert="true" 
+    		dynamic-update="true">
+        	<key column="superid"/>
+        	<set name="strings" table="monostrings">
+        		<key column="monoid_"/>
+        		<element type="string" column="str_"/>
+        	</set>
+        </joined-subclass>
+
+
+</hibernate-mapping>
