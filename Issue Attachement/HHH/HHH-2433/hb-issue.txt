Version: Hibernate3.jar

Somewhere in the code (get a list of recipients)
    tx = session.beginTransaction();
    q = session.createQuery("from Recipient");
    recipientList = q.list();
    recipient = recipientList.get(0);


Somewhere else in the code (change the first recipient)
    tx = session.beginTransaction();
    recipient.setName("foo");
    session.update(this.recipient);
    tx.commit();   <---- ArrayIndexOutOfBoundsException


Same code with a warkaround 
    tx = session.beginTransaction();
    session.load(recipient, recipient.getInstanceId()); <--- extra load!!
    recipient.setName("foo");
    session.update(this.recipient);
    tx.commit(); 



Table Definition:
=================
recipient
RecipientId	VARCHAR(50) 1st PrimaryKey (Natural id)
InstanceId	VARCHAR(2)  2nd PrimaryKey (Internal id)
Name		VARCHAR(50)
Version		INTEGER


Hibernate Mapping:
==================
<hibernate-mapping package="com.osirion.messaging">
  <class name="Recipient" table="recipient">
    <id name="instanceId" type="string" column="InstanceId" unsaved-value="none">
      <generator class="org.hibernate.id.UUIDHexGenerator"/>
    </id>
    <natural-id mutable="false">
      <property name="recipientId" type="string" column="RecipientId"/>
    </natural-id>
    <version name="version" column="Version" type="integer" unsaved-value="null"/>
    <property name="name" type="string" column="Name"/>
  </class>
</hibernate-mapping>


Stack Trace:
============
Thread [PoolThread-4] (Suspended (exception java.lang.ArrayIndexOutOfBoundsException))	
	org.hibernate.event.def.DefaultFlushEntityEventListener.checkNaturalId(org.hibernate.persister.entity.EntityPersister, java.io.Serializable, java.lang.Object[], java.lang.Object[], org.hibernate.EntityMode, org.hibernate.engine.SessionImplementor) line: 86	
	org.hibernate.event.def.DefaultFlushEntityEventListener.getValues(java.lang.Object, org.hibernate.engine.EntityEntry, org.hibernate.EntityMode, boolean, org.hibernate.engine.SessionImplementor) line: 162	
	org.hibernate.event.def.DefaultFlushEntityEventListener.onFlushEntity(org.hibernate.event.FlushEntityEvent) line: 113	
	org.hibernate.event.def.DefaultFlushEventListener(org.hibernate.event.def.AbstractFlushingEventListener).flushEntities(org.hibernate.event.FlushEvent) line: 196	
	org.hibernate.event.def.DefaultFlushEventListener(org.hibernate.event.def.AbstractFlushingEventListener).flushEverythingToExecutions(org.hibernate.event.FlushEvent) line: 76	
	org.hibernate.event.def.DefaultFlushEventListener.onFlush(org.hibernate.event.FlushEvent) line: 26	
	org.hibernate.impl.SessionImpl.flush() line: 1000	
	org.hibernate.impl.SessionImpl.managedFlush() line: 338	
	org.hibernate.transaction.JDBCTransaction.commit() line: 106	
	sun.reflect.NativeMethodAccessorImpl.invoke0(java.lang.reflect.Method, java.lang.Object, java.lang.Object[]) line: not available [native method]	
	sun.reflect.NativeMethodAccessorImpl.invoke(java.lang.Object, java.lang.Object[]) line: not available	
	sun.reflect.DelegatingMethodAccessorImpl.invoke(java.lang.Object, java.lang.Object[]) line: not available	
	java.lang.reflect.Method.invoke(java.lang.Object, java.lang.Object...) line: not available	
	org.mozilla.javascript.MemberBox.invoke(java.lang.Object, java.lang.Object[]) line: 145	
	org.mozilla.javascript.NativeJavaMethod.call(org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 204	
	org.mozilla.javascript.Interpreter.interpretLoop(org.mozilla.javascript.Context, org.mozilla.javascript.Interpreter$CallFrame, java.lang.Object) line: 3085	
	org.mozilla.javascript.Interpreter.interpret(org.mozilla.javascript.InterpretedFunction, org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 2251	
	org.mozilla.javascript.InterpretedFunction.call(org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 161	
	org.apache.cocoon.forms.util.JavaScriptHelper.callFunction(org.mozilla.javascript.Function, java.lang.Object, java.lang.Object[], java.util.Map) line: 241	
	org.apache.cocoon.forms.event.impl.JavaScriptWidgetListener$JSActionListener(org.apache.cocoon.forms.event.impl.JavaScriptWidgetListener).callScript(org.apache.cocoon.forms.event.WidgetEvent) line: 65	
	org.apache.cocoon.forms.event.impl.JavaScriptWidgetListener$JSActionListener.actionPerformed(org.apache.cocoon.forms.event.ActionEvent) line: 81	
	org.apache.cocoon.forms.formmodel.ActionDefinition.fireActionEvent(org.apache.cocoon.forms.event.ActionEvent) line: 69	
	org.apache.cocoon.forms.formmodel.Action.broadcastEvent(org.apache.cocoon.forms.event.WidgetEvent) line: 149	
	org.apache.cocoon.forms.formmodel.Form.fireEvents() line: 174	
	org.apache.cocoon.forms.formmodel.Form.process(org.apache.cocoon.forms.FormContext) line: 358	
	sun.reflect.NativeMethodAccessorImpl.invoke0(java.lang.reflect.Method, java.lang.Object, java.lang.Object[]) line: not available [native method]	
	sun.reflect.NativeMethodAccessorImpl.invoke(java.lang.Object, java.lang.Object[]) line: not available	
	sun.reflect.DelegatingMethodAccessorImpl.invoke(java.lang.Object, java.lang.Object[]) line: not available	
	java.lang.reflect.Method.invoke(java.lang.Object, java.lang.Object...) line: not available	
	org.mozilla.javascript.MemberBox.invoke(java.lang.Object, java.lang.Object[]) line: 145	
	org.mozilla.javascript.NativeJavaMethod.call(org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 204	
	org.mozilla.javascript.Interpreter.interpretLoop(org.mozilla.javascript.Context, org.mozilla.javascript.Interpreter$CallFrame, java.lang.Object) line: 3085	
	org.mozilla.javascript.Interpreter.interpret(org.mozilla.javascript.InterpretedFunction, org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 2251	
	org.mozilla.javascript.InterpretedFunction.call(org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 161	
	org.mozilla.javascript.ContextFactory.doTopCall(org.mozilla.javascript.Callable, org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 340	
	org.mozilla.javascript.ScriptRuntime.doTopCall(org.mozilla.javascript.Callable, org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 2758	
	org.mozilla.javascript.InterpretedFunction.call(org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 159	
	org.mozilla.javascript.Context.call(org.mozilla.javascript.ContextFactory, org.mozilla.javascript.Callable, org.mozilla.javascript.Scriptable, org.mozilla.javascript.Scriptable, java.lang.Object[]) line: 489	
	org.mozilla.javascript.ScriptableObject.callMethod(org.mozilla.javascript.Context, org.mozilla.javascript.Scriptable, java.lang.String, java.lang.Object[]) line: 1556	
	org.mozilla.javascript.ScriptableObject.callMethod(org.mozilla.javascript.Scriptable, java.lang.String, java.lang.Object[]) line: 1526	
	org.apache.cocoon.components.flow.javascript.fom.FOM_JavaScriptInterpreter.handleContinuation(java.lang.String, java.util.List, org.apache.cocoon.environment.Redirector) line: 842	
	org.apache.cocoon.components.treeprocessor.sitemap.CallFunctionNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 124	
	org.apache.cocoon.components.treeprocessor.sitemap.SelectNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 69	
	org.apache.cocoon.components.treeprocessor.sitemap.SelectNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 103	
	org.apache.cocoon.components.treeprocessor.sitemap.MatchNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext, java.lang.String, java.util.Map) line: 47	
	org.apache.cocoon.components.treeprocessor.sitemap.MatchNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 108	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelineNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 69	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelineNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 143	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelinesNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 69	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelinesNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 93	
	org.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 235	
	org.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(org.apache.cocoon.environment.Environment) line: 177	
	org.apache.cocoon.components.treeprocessor.TreeProcessor.process(org.apache.cocoon.environment.Environment) line: 253	
	org.apache.cocoon.components.treeprocessor.sitemap.MountNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 118	
	org.apache.cocoon.components.treeprocessor.sitemap.SelectNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 69	
	org.apache.cocoon.components.treeprocessor.sitemap.SelectNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 103	
	org.apache.cocoon.components.treeprocessor.sitemap.MatchNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext, java.lang.String, java.util.Map) line: 47	
	org.apache.cocoon.components.treeprocessor.sitemap.MatchNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 108	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelineNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 69	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelineNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 143	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelinesNode(org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode).invokeNodes(org.apache.cocoon.components.treeprocessor.ProcessingNode[], org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 69	
	org.apache.cocoon.components.treeprocessor.sitemap.PipelinesNode.invoke(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 93	
	org.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(org.apache.cocoon.environment.Environment, org.apache.cocoon.components.treeprocessor.InvokeContext) line: 235	
	org.apache.cocoon.components.treeprocessor.ConcreteTreeProcessor.process(org.apache.cocoon.environment.Environment) line: 177	
	org.apache.cocoon.components.treeprocessor.TreeProcessor.process(org.apache.cocoon.environment.Environment) line: 253	
	org.apache.cocoon.Cocoon.process(org.apache.cocoon.environment.Environment) line: 699	
	org.apache.cocoon.servlet.CocoonServlet.service(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse) line: 1154	
	org.apache.cocoon.servlet.CocoonServlet(javax.servlet.http.HttpServlet).service(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 853	
	org.mortbay.jetty.servlet.ServletHolder.handle(javax.servlet.ServletRequest, javax.servlet.ServletResponse) line: 358	
	org.mortbay.jetty.servlet.WebApplicationHandler.dispatch(java.lang.String, javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, org.mortbay.jetty.servlet.ServletHolder) line: 294	
	org.mortbay.jetty.servlet.WebApplicationHandler(org.mortbay.jetty.servlet.ServletHandler).handle(java.lang.String, java.lang.String, org.mortbay.http.HttpRequest, org.mortbay.http.HttpResponse) line: 567	
	org.mortbay.jetty.servlet.WebApplicationContext(org.mortbay.http.HttpContext).handle(java.lang.String, java.lang.String, org.mortbay.http.HttpRequest, org.mortbay.http.HttpResponse) line: 1807	
	org.mortbay.jetty.servlet.WebApplicationContext.handle(java.lang.String, java.lang.String, org.mortbay.http.HttpRequest, org.mortbay.http.HttpResponse) line: 525	
	org.mortbay.jetty.servlet.WebApplicationContext(org.mortbay.http.HttpContext).handle(org.mortbay.http.HttpRequest, org.mortbay.http.HttpResponse) line: 1757	
	org.mortbay.jetty.Server(org.mortbay.http.HttpServer).service(org.mortbay.http.HttpRequest, org.mortbay.http.HttpResponse) line: 879	
	org.mortbay.http.HttpConnection.service(org.mortbay.http.HttpRequest, org.mortbay.http.HttpResponse) line: 789	
	org.mortbay.http.HttpConnection.handleNext() line: 960	
	org.mortbay.http.HttpConnection.handle() line: 806	
	org.mortbay.http.SocketListener.handleConnection(java.net.Socket) line: 218	
	org.mortbay.http.SocketListener(org.mortbay.util.ThreadedServer).handle(java.lang.Object) line: 300	
	org.mortbay.util.ThreadPool$PoolThread.run() line: 511	
