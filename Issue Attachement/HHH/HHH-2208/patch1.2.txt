Index: C:/anthony/Hibernate3/test/org/hibernate/test/tool/TestSchemaTools.java
===================================================================
--- C:/anthony/Hibernate3/test/org/hibernate/test/tool/TestSchemaTools.java	(revision 0)
+++ C:/anthony/Hibernate3/test/org/hibernate/test/tool/TestSchemaTools.java	(revision 0)
@@ -0,0 +1,96 @@
+package org.hibernate.test.tool;
+
+import java.sql.Connection;
+import java.sql.Statement;
+
+import junit.framework.Test;
+import junit.framework.TestSuite;
+import junit.textui.TestRunner;
+
+import org.hibernate.Session;
+import org.hibernate.test.TestCase;
+import org.hibernate.tool.hbm2ddl.SchemaExport;
+import org.hibernate.tool.hbm2ddl.SchemaUpdate;
+import org.hibernate.tool.hbm2ddl.SchemaValidator;
+
+/**
+ * @author Anthony
+ * WARNING, if you want this test to be efficient, you need to define a default schema = SB
+ * in hibernate global configuration.
+ * This schema should not be the same at the default db user schema and should come after the users schema alphabetically.
+ *
+ */
+public class TestSchemaTools extends TestCase{
+	
+	public void testSchemaTools() throws Exception{
+		// database schema have been created thanks to the setUp method
+		// we have 2 schemas SA et SB, SB must be set as the default schema
+		// used by hibernate hibernate.default_schema SB
+		SchemaExport se = new SchemaExport(getCfg());
+		se.create(true,true);
+		
+		// here we modify the generated table in order to test SchemaUpdate
+		Session session = openSession();
+		Connection conn = session.connection();
+		Statement stat = conn.createStatement();
+		stat.execute("ALTER TABLE \"SB\".\"TEAM\" DROP COLUMN name ");
+		
+		// update schema
+		SchemaUpdate su = new SchemaUpdate(getCfg());
+		su.execute(true,true);
+		
+		// we can run schema validation. Note that in the setUp method a *wrong* table
+		// has been created with different column names
+		// if schema validator chooses the bad db schema, then the testcase will fail (exception)
+		SchemaValidator sv = new SchemaValidator(getCfg());
+		sv.validate();
+		
+		// it's time to clean our database
+		se.drop(true,true);
+		
+		// then the schemas and false table.
+
+		stat.execute("DROP TABLE \"SA\".\"TEAM\" ");
+		stat.execute(" DROP SCHEMA sa ");
+		stat.execute("DROP SCHEMA sb ");
+		stat.close();
+		session.close();
+	}
+	
+	public TestSchemaTools(String arg0) {
+		super(arg0);
+	}
+	
+	public String[] getMappings() {
+		return new String[] {"tool/Team.hbm.xml"};
+	}
+
+	public static Test suite() {
+		return new TestSuite(TestSchemaTools.class);
+	}
+	
+	public static void main(String[] args) throws Exception {
+		TestRunner.run( suite() );
+	}
+
+	protected boolean recreateSchema() {
+		return false;
+	}
+
+	
+	protected void setUp() throws Exception {
+		super.setUp();
+		Session session = openSession();
+		Connection conn = session.connection();
+		Statement stat = conn.createStatement();
+		stat.execute("CREATE SCHEMA sb AUTHORIZATION DBA ");
+		stat.execute(" CREATE SCHEMA sa AUTHORIZATION DBA ");
+		stat.execute(" CREATE TABLE \"SA\".\"TEAM\" (test INTEGER) ");
+		stat.close();
+		conn.close();
+		
+	}
+	
+
+
+}
Index: C:/anthony/Hibernate3/test/org/hibernate/test/tool/Team.java
===================================================================
--- C:/anthony/Hibernate3/test/org/hibernate/test/tool/Team.java	(revision 0)
+++ C:/anthony/Hibernate3/test/org/hibernate/test/tool/Team.java	(revision 0)
@@ -0,0 +1,20 @@
+package org.hibernate.test.tool;
+
+
+public class Team {
+	private Long id;
+	private String name;
+	public Long getId() {
+		return id;
+	}
+	public void setId(Long id) {
+		this.id = id;
+	}
+	public String getName() {
+		return name;
+	}
+	public void setName(String name) {
+		this.name = name;
+	}
+		
+}
Index: C:/anthony/Hibernate3/test/org/hibernate/test/tool/Team.hbm.xml
===================================================================
--- C:/anthony/Hibernate3/test/org/hibernate/test/tool/Team.hbm.xml	(revision 0)
+++ C:/anthony/Hibernate3/test/org/hibernate/test/tool/Team.hbm.xml	(revision 0)
@@ -0,0 +1,15 @@
+<?xml version="1.0"?>
+<!DOCTYPE hibernate-mapping SYSTEM
+  "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
+  
+<hibernate-mapping package="org.hibernate.test.tool">
+	<class name="Team">
+	  	<id name="id">
+		  <generator class="native">
+		  <param name="sequence">TEAM_SEQ</param>
+		  </generator>
+	  	</id>
+	  	<property name="name"/>
+	</class>
+
+</hibernate-mapping>
Index: C:/anthony/Hibernate3/src/org/hibernate/cfg/Configuration.java
===================================================================
--- C:/anthony/Hibernate3/src/org/hibernate/cfg/Configuration.java	(revision 10539)
+++ C:/anthony/Hibernate3/src/org/hibernate/cfg/Configuration.java	(working copy)
@@ -874,11 +874,12 @@
 		while ( iter.hasNext() ) {
 			Table table = (Table) iter.next();
 			if ( table.isPhysicalTable() ) {
-
+				Settings settings = buildSettings();
 				TableMetadata tableInfo = databaseMetadata.getTableMetadata(
 						table.getName(),
-						table.getSchema(),
-						table.getCatalog()
+						( table.getSchema() == null ) ? settings.getDefaultSchemaName() : table.getSchema(),
+						( table.getCatalog() == null ) ? settings.getDefaultCatalogName() : table.getCatalog()
+
 					);
 				if ( tableInfo == null ) {
 					script.add(
@@ -993,13 +994,12 @@
 		while ( iter.hasNext() ) {
 			Table table = (Table) iter.next();
 			if ( table.isPhysicalTable() ) {
+				Settings settings = buildSettings();
 
 				TableMetadata tableInfo = databaseMetadata.getTableMetadata(
 						table.getName(),
-						table.getSchema(),
-						table.getCatalog()
-					);
-
+						( table.getSchema() == null ) ? settings.getDefaultSchemaName() : table.getSchema(),
+						( table.getCatalog() == null ) ? settings.getDefaultCatalogName() : table.getCatalog());
 				if ( tableInfo == null ) {
 					throw new HibernateException( "Missing table: " + table.getName() );
 				}
Index: C:/anthony/Hibernate3/src/org/hibernate/tool/hbm2ddl/DatabaseMetadata.java
===================================================================
--- C:/anthony/Hibernate3/src/org/hibernate/tool/hbm2ddl/DatabaseMetadata.java	(revision 10539)
+++ C:/anthony/Hibernate3/src/org/hibernate/tool/hbm2ddl/DatabaseMetadata.java	(working copy)
@@ -132,7 +132,11 @@
 	}
 
 	public boolean isSequence(Object key) {
-		return key instanceof String && sequences.contains( ( (String) key ).toLowerCase() );
+		if (key instanceof String){
+			String[] strings = StringHelper.split(".", (String) key);
+			return sequences.contains( ( (String) strings[strings.length-1] ).toLowerCase());
+		}
+		return false;
 	}
 
 	public boolean isTable(Object key) throws HibernateException {

