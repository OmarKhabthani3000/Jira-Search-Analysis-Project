From e839e7950367e68f8cf5d7dcfb4cd675f07d9d3f Mon Sep 17 00:00:00 2001
From: Hardy <hardy@ferentschik.de>
Date: Thu, 8 Jul 2010 10:26:29 +0200
Subject: [PATCH] HHH-5359 Testcase for bidirectional association in derived entity case

---
 .../derivedidentities/bidirectional/Dependent.java |   42 ++++++++++++
 .../bidirectional/DependentId.java                 |   33 +++++++++
 ...edIdentityWithBidirectionalAssociationTest.java |   69 ++++++++++++++++++++
 .../derivedidentities/bidirectional/Employee.java  |   43 ++++++++++++
 4 files changed, 187 insertions(+), 0 deletions(-)
 create mode 100644 annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Dependent.java
 create mode 100644 annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DependentId.java
 create mode 100644 annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DerivedIdentityWithBidirectionalAssociationTest.java
 create mode 100644 annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Employee.java

diff --git a/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Dependent.java b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Dependent.java
new file mode 100644
index 0000000..44a6c2e
--- /dev/null
+++ b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Dependent.java
@@ -0,0 +1,42 @@
+/*
+ * Hibernate, Relational Persistence for Idiomatic Java
+ *
+ * Copyright (c) 2010, Red Hat Inc. or third-party contributors as
+ * indicated by the @author tags or express copyright attribution
+ * statements applied by the authors.  All third-party contributions are
+ * distributed under license by Red Hat Inc.
+ *
+ * This copyrighted material is made available to anyone wishing to use, modify,
+ * copy, or redistribute it subject to the terms and conditions of the GNU
+ * Lesser General Public License, as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+ * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License
+ * for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * along with this distribution; if not, write to:
+ * Free Software Foundation, Inc.
+ * 51 Franklin Street, Fifth Floor
+ * Boston, MA  02110-1301  USA
+ */
+package org.hibernate.test.annotations.derivedidentities.bidirectional;
+
+import java.io.Serializable;
+import javax.persistence.Entity;
+import javax.persistence.Id;
+import javax.persistence.ManyToOne;
+
+/**
+ * @author Hardy Ferentschik
+ */
+@Entity
+//@IdClass(DependentId.class)
+public class Dependent implements Serializable {
+	@Id
+	@ManyToOne
+	Employee emp;
+
+	String name;
+}
\ No newline at end of file
diff --git a/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DependentId.java b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DependentId.java
new file mode 100644
index 0000000..1283aec
--- /dev/null
+++ b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DependentId.java
@@ -0,0 +1,33 @@
+/*
+ * Hibernate, Relational Persistence for Idiomatic Java
+ *
+ * Copyright (c) 2010, Red Hat Inc. or third-party contributors as
+ * indicated by the @author tags or express copyright attribution
+ * statements applied by the authors.  All third-party contributions are
+ * distributed under license by Red Hat Inc.
+ *
+ * This copyrighted material is made available to anyone wishing to use, modify,
+ * copy, or redistribute it subject to the terms and conditions of the GNU
+ * Lesser General Public License, as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+ * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License
+ * for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * along with this distribution; if not, write to:
+ * Free Software Foundation, Inc.
+ * 51 Franklin Street, Fifth Floor
+ * Boston, MA  02110-1301  USA
+ */
+package org.hibernate.test.annotations.derivedidentities.bidirectional;
+
+/**
+ * @author Hardy Ferentschik
+ */
+public class DependentId {
+	long emp; // matches name of @Id attribute and type of Employee PK
+}
+
+
diff --git a/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DerivedIdentityWithBidirectionalAssociationTest.java b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DerivedIdentityWithBidirectionalAssociationTest.java
new file mode 100644
index 0000000..cb9e9da
--- /dev/null
+++ b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/DerivedIdentityWithBidirectionalAssociationTest.java
@@ -0,0 +1,69 @@
+/*
+ * Hibernate, Relational Persistence for Idiomatic Java
+ *
+ * Copyright (c) 2010, Red Hat Inc. or third-party contributors as
+ * indicated by the @author tags or express copyright attribution
+ * statements applied by the authors.  All third-party contributions are
+ * distributed under license by Red Hat Inc.
+ *
+ * This copyrighted material is made available to anyone wishing to use, modify,
+ * copy, or redistribute it subject to the terms and conditions of the GNU
+ * Lesser General Public License, as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+ * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License
+ * for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * along with this distribution; if not, write to:
+ * Free Software Foundation, Inc.
+ * 51 Franklin Street, Fifth Floor
+ * Boston, MA  02110-1301  USA
+ */
+package org.hibernate.test.annotations.derivedidentities.bidirectional;
+
+import org.hibernate.Session;
+import org.hibernate.test.annotations.TestCase;
+import org.hibernate.test.util.SchemaUtil;
+
+/**
+ * @author Hardy Ferentschik
+ */
+public class DerivedIdentityWithBidirectionalAssociationTest extends TestCase {
+
+	public void testBidirectionalAssociation() throws Exception {
+		assertTrue( SchemaUtil.isColumnPresent( "Dependent", "emp_empId", getCfg() ) );
+		assertTrue( !SchemaUtil.isColumnPresent( "Dependent", "empPK", getCfg() ) );
+		Employee e = new Employee();
+		e.empId = 1;
+		e.empName = "Emmanuel";
+
+		Session s = openSession();
+		s.getTransaction().begin();
+		s.persist( e );
+		Dependent d = new Dependent();
+		d.emp = e;
+		s.persist( d );
+		s.flush();
+		s.clear();
+		d = getDerivedClassById( e, s, Dependent.class );
+		assertEquals( e.empId, d.emp.empId );
+		s.getTransaction().rollback();
+		s.close();
+	}
+
+	private <T> T getDerivedClassById(Employee e, Session s, Class<T> clazz) {
+		return ( T )
+				s.createQuery( "from " + clazz.getName() + " d where d.emp.empId = :empId" )
+						.setParameter( "empId", e.empId ).uniqueResult();
+	}
+
+	@Override
+	protected Class<?>[] getAnnotatedClasses() {
+		return new Class<?>[] {
+				Dependent.class,
+				Employee.class
+		};
+	}
+}
\ No newline at end of file
diff --git a/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Employee.java b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Employee.java
new file mode 100644
index 0000000..c82b320
--- /dev/null
+++ b/annotations/src/test/java/org/hibernate/test/annotations/derivedidentities/bidirectional/Employee.java
@@ -0,0 +1,43 @@
+/*
+ * Hibernate, Relational Persistence for Idiomatic Java
+ *
+ * Copyright (c) 2010, Red Hat Inc. or third-party contributors as
+ * indicated by the @author tags or express copyright attribution
+ * statements applied by the authors.  All third-party contributions are
+ * distributed under license by Red Hat Inc.
+ *
+ * This copyrighted material is made available to anyone wishing to use, modify,
+ * copy, or redistribute it subject to the terms and conditions of the GNU
+ * Lesser General Public License, as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+ * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License
+ * for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public License
+ * along with this distribution; if not, write to:
+ * Free Software Foundation, Inc.
+ * 51 Franklin Street, Fifth Floor
+ * Boston, MA  02110-1301  USA
+ */
+package org.hibernate.test.annotations.derivedidentities.bidirectional;
+
+import java.util.Set;
+import javax.persistence.Entity;
+import javax.persistence.FetchType;
+import javax.persistence.Id;
+import javax.persistence.OneToMany;
+
+/**
+ * @author Hardy Ferentschik
+ */
+@Entity
+public class Employee {
+	@Id
+	long empId;
+	String empName;
+
+	@OneToMany(mappedBy = "emp", fetch = FetchType.LAZY)
+	private Set<Dependent> dependents;
+}
\ No newline at end of file
-- 
1.6.6

