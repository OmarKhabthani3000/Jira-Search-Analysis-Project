*** src/org/hibernate/event/def/AbstractSaveEventListener.java  Thu Dec  7 22:53:41 2006
--- /home/jal/wsnew/bin-hibernate-3.2.3/src/org/hibernate/event/def/AbstractSaveEventListener.java      Fri May  4 15:37:34 2007
***************
*** 21,26 ****
--- 21,27 ----
  import org.hibernate.engine.Nullability;
  import org.hibernate.engine.SessionImplementor;
  import org.hibernate.engine.Status;
+ import org.hibernate.engine.ValueInclusion;
  import org.hibernate.engine.Versioning;
  import org.hibernate.event.EventSource;
  import org.hibernate.id.IdentifierGenerationException;
***************
*** 329,334 ****
--- 330,347 ----
                        source.getActionQueue().addAction(
                                        new EntityInsertAction( id, values, entity, version, persister, source )
                        );
+
+               /*
+                * Bugfix for HHH-2588 start: if the entity has "generated at insert time" properties
+                * we need to insert this record immediately. The insert will cause the properties that
+                * are generated to be read back and pushed into the entity before follow-up updates
+                * are done which need those generated properties.
+                */
+               ValueInclusion[]  viar = persister.getPropertyInsertGenerationInclusions();
+               if(viar != null && viar.length > 0) {
+                   log.trace( "executing insertions" );
+                   source.getActionQueue().executeInserts();
+               }
                }

                cascadeAfterSave( source, persister, entity, anything );
