Index: CGLIBLazyInitializer.java
===================================================================
RCS file: /cvsroot/hibernate/Hibernate3/src/org/hibernate/proxy/CGLIBLazyInitializer.java,v
retrieving revision 1.9
diff -u -r1.9 CGLIBLazyInitializer.java
--- CGLIBLazyInitializer.java	21 Mar 2005 16:08:28 -0000	1.9
+++ CGLIBLazyInitializer.java	24 May 2005 11:24:52 -0000
@@ -63,7 +63,7 @@
 	}
 
 	public static HibernateProxy getProxy(
-		final Factory factory,
+		final Class factory,
 		final String entityName,
 		final Class persistentClass,
 		final Class[] interfaces,
@@ -83,21 +83,31 @@
 			componentIdType,
 			session
 		);
-		final HibernateProxy proxy = (HibernateProxy) factory.newInstance(instance);
+		final HibernateProxy proxy;
+        try {
+            proxy = (HibernateProxy) factory.newInstance();
+        } catch (Exception e) {
+            throw new HibernateException( "CGLIB Enhancement failed: " + persistentClass.getName(), e );
+        } 
+        ((Factory)proxy).setCallback(0,instance);
 		instance.constructed = true;
+		
 		return proxy;
 	}
 
-	public static Factory getProxyFactory(Class persistentClass, Class[] interfaces) throws HibernateException {
+	public static Class getProxyFactory(Class persistentClass, Class[] interfaces) throws HibernateException {
 		//note: interfaces is assumed to already contain HibernateProxy.class
 		try {
-			return (Factory) Enhancer.create(
-				(interfaces.length==1) ?
-					persistentClass :
-					null,
-				interfaces,
-				NULL_METHOD_INTERCEPTOR
-			);
+		    
+		    Enhancer en = new Enhancer();
+		    en.setUseCache(false);
+		    en.setInterceptDuringConstruction(false);
+		    en.setCallbackType(MethodInterceptor.class);
+		    en.setSuperclass( (interfaces.length==1) ? persistentClass : null );
+		    en.setInterfaces(interfaces);
+		    
+			return en.createClass();
+			
 		}
 		catch (Throwable t) {
 			LogFactory.getLog(BasicLazyInitializer.class).error(
Index: CGLIBProxyFactory.java
===================================================================
RCS file: /cvsroot/hibernate/Hibernate3/src/org/hibernate/proxy/CGLIBProxyFactory.java,v
retrieving revision 1.3
diff -u -r1.3 CGLIBProxyFactory.java
--- CGLIBProxyFactory.java	12 Feb 2005 07:19:45 -0000	1.3
+++ CGLIBProxyFactory.java	24 May 2005 11:24:52 -0000
@@ -23,7 +23,7 @@
 	private Method getIdentifierMethod;
 	private Method setIdentifierMethod;
 	private AbstractComponentType componentIdType;
-	private Factory factory;
+	private Class factory;
 
 	public void postInstantiate(
 		final String entityName,
