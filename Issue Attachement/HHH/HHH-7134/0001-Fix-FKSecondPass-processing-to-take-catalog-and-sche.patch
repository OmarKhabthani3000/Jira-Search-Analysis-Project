From 9346e2185b5e8f8d6f5e2eae87d0138a6244c6d4 Mon Sep 17 00:00:00 2001
From: Didier Villevalois <dvillevalois@clinigrid.com>
Date: Thu, 1 Mar 2012 15:44:38 +0100
Subject: [PATCH] Fix FKSecondPass processing to take catalog and schema in
 accounts

---
 .../main/java/org/hibernate/cfg/Configuration.java |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/hibernate-core/src/main/java/org/hibernate/cfg/Configuration.java b/hibernate-core/src/main/java/org/hibernate/cfg/Configuration.java
index 2de80e0..ffae071 100644
--- a/hibernate-core/src/main/java/org/hibernate/cfg/Configuration.java
+++ b/hibernate-core/src/main/java/org/hibernate/cfg/Configuration.java
@@ -1415,7 +1415,7 @@ public class Configuration implements Serializable {
 			if ( sp.isInPrimaryKey() ) {
 				String referenceEntityName = sp.getReferencedEntityName();
 				PersistentClass classMapping = getClassMapping( referenceEntityName );
-				String dependentTable = classMapping.getTable().getQuotedName();
+				String dependentTable = quotedTableName(classMapping.getTable());
 				if ( !isADependencyOf.containsKey( dependentTable ) ) {
 					isADependencyOf.put( dependentTable, new HashSet<FkSecondPass>() );
 				}
@@ -1485,7 +1485,7 @@ public class Configuration implements Serializable {
 		}
 
 		for ( FkSecondPass sp : dependencies ) {
-			String dependentTable = sp.getValue().getTable().getQuotedName();
+			String dependentTable = quotedTableName(sp.getValue().getTable());
 			if ( dependentTable.compareTo( startTable ) == 0 ) {
 				StringBuilder sb = new StringBuilder(
 						"Foreign key circularity dependency involving the following tables: "
@@ -1499,6 +1499,10 @@ public class Configuration implements Serializable {
 		}
 	}
 
+	private String quotedTableName(Table table) {
+		return Table.qualify( table.getCatalog(), table.getQuotedSchema(), table.getQuotedName() );
+	}
+
 	private void processEndOfQueue(List<FkSecondPass> endOfQueueFkSecondPasses) {
 		/*
 		 * If a second pass raises a recoverableException, queue it for next round
-- 
1.7.5.4

