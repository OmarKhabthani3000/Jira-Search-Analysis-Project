Index: src/org/hibernate/dialect/InformixDialect.java
===================================================================
RCS file: /cvs/hibernate-3.2/src/org/hibernate/dialect/InformixDialect.java,v
retrieving revision 1.1
diff -u -r1.1 InformixDialect.java
--- src/org/hibernate/dialect/InformixDialect.java	9 Jan 2007 17:24:44 -0000	1.1
+++ src/org/hibernate/dialect/InformixDialect.java	9 Jan 2007 21:33:02 -0000
@@ -175,15 +175,16 @@
 		public String extractConstraintName(SQLException sqle) {
 			String constraintName = null;
 			
-			int errorCode = JDBCExceptionHelper.extractErrorCode(sqle);
+            SQLException sqlException = JDBCExceptionHelper.extractExceptionUsingErrorCode(sqle);
+			int errorCode = JDBCExceptionHelper.extractErrorCode(sqlException);
 			if ( errorCode == -268 ) {
-				constraintName = extractUsingTemplate( "Unique constraint (", ") violated.", sqle.getMessage() );
+				constraintName = extractUsingTemplate( "Unique constraint (", ") violated.", sqlException.getMessage() );
 			}
 			else if ( errorCode == -691 ) {
-				constraintName = extractUsingTemplate( "Missing key in referenced table for referential constraint (", ").", sqle.getMessage() );
+				constraintName = extractUsingTemplate( "Missing key in referenced table for referential constraint (", ").", sqlException.getMessage() );
 			}
 			else if ( errorCode == -692 ) {
-				constraintName = extractUsingTemplate( "Key value for constraint (", ") is still being referenced.", sqle.getMessage() );
+				constraintName = extractUsingTemplate( "Key value for constraint (", ") is still being referenced.", sqlException.getMessage() );
 			}
 			
 			if (constraintName != null) {
Index: src/org/hibernate/dialect/HSQLDialect.java
===================================================================
RCS file: /cvs/hibernate-3.2/src/org/hibernate/dialect/HSQLDialect.java,v
retrieving revision 1.1
diff -u -r1.1 HSQLDialect.java
--- src/org/hibernate/dialect/HSQLDialect.java	9 Jan 2007 17:24:44 -0000	1.1
+++ src/org/hibernate/dialect/HSQLDialect.java	9 Jan 2007 21:33:02 -0000
@@ -245,26 +245,27 @@
 		public String extractConstraintName(SQLException sqle) {
 			String constraintName = null;
 
-			int errorCode = JDBCExceptionHelper.extractErrorCode( sqle );
+            SQLException sqlException = JDBCExceptionHelper.extractExceptionUsingErrorCode(sqle);
+			int errorCode = JDBCExceptionHelper.extractErrorCode( sqlException );
 
 			if ( errorCode == -8 ) {
 				constraintName = extractUsingTemplate(
-						"Integrity constraint violation ", " table:", sqle.getMessage()
+						"Integrity constraint violation ", " table:", sqlException.getMessage()
 				);
 			}
 			else if ( errorCode == -9 ) {
 				constraintName = extractUsingTemplate(
-						"Violation of unique index: ", " in statement [", sqle.getMessage()
+						"Violation of unique index: ", " in statement [", sqlException.getMessage()
 				);
 			}
 			else if ( errorCode == -104 ) {
 				constraintName = extractUsingTemplate(
-						"Unique constraint violation: ", " in statement [", sqle.getMessage()
+						"Unique constraint violation: ", " in statement [", sqlException.getMessage()
 				);
 			}
 			else if ( errorCode == -177 ) {
 				constraintName = extractUsingTemplate(
-						"Integrity constraint violation - no parent ", " table:", sqle.getMessage()
+						"Integrity constraint violation - no parent ", " table:", sqlException.getMessage()
 				);
 			}
 
Index: src/org/hibernate/dialect/PostgreSQLDialect.java
===================================================================
RCS file: /cvs/hibernate-3.2/src/org/hibernate/dialect/PostgreSQLDialect.java,v
retrieving revision 1.1
diff -u -r1.1 PostgreSQLDialect.java
--- src/org/hibernate/dialect/PostgreSQLDialect.java	9 Jan 2007 17:24:44 -0000	1.1
+++ src/org/hibernate/dialect/PostgreSQLDialect.java	9 Jan 2007 21:33:02 -0000
@@ -272,16 +272,17 @@
 	private static ViolatedConstraintNameExtracter EXTRACTER = new TemplatedViolatedConstraintNameExtracter() {
 		public String extractConstraintName(SQLException sqle) {
 			try {
-				int sqlState = Integer.valueOf( JDBCExceptionHelper.extractSqlState(sqle)).intValue();
+                final SQLException sqlException = JDBCExceptionHelper.extractExceptionUsingSQLState(sqle);
+                int sqlState = Integer.valueOf(JDBCExceptionHelper.extractSqlState(sqlException)).intValue();
 				switch (sqlState) {
 					// CHECK VIOLATION
-					case 23514: return extractUsingTemplate("violates check constraint \"","\"", sqle.getMessage());
+					case 23514: return extractUsingTemplate("violates check constraint \"","\"", sqlException.getMessage());
 					// UNIQUE VIOLATION
-					case 23505: return extractUsingTemplate("violates unique constraint \"","\"", sqle.getMessage());
+					case 23505: return extractUsingTemplate("violates unique constraint \"","\"", sqlException.getMessage());
 					// FOREIGN KEY VIOLATION
-					case 23503: return extractUsingTemplate("violates foreign key constraint \"","\"", sqle.getMessage());
+					case 23503: return extractUsingTemplate("violates foreign key constraint \"","\"", sqlException.getMessage());
 					// NOT NULL VIOLATION
-					case 23502: return extractUsingTemplate("null value in column \"","\" violates not-null constraint", sqle.getMessage());
+					case 23502: return extractUsingTemplate("null value in column \"","\" violates not-null constraint", sqlException.getMessage());
 					// TODO: RESTRICT VIOLATION
 					case 23001: return null;
 					// ALL OTHER
Index: src/org/hibernate/dialect/Oracle9Dialect.java
===================================================================
RCS file: /cvs/hibernate-3.2/src/org/hibernate/dialect/Oracle9Dialect.java,v
retrieving revision 1.1
diff -u -r1.1 Oracle9Dialect.java
--- src/org/hibernate/dialect/Oracle9Dialect.java	9 Jan 2007 17:24:44 -0000	1.1
+++ src/org/hibernate/dialect/Oracle9Dialect.java	9 Jan 2007 21:33:02 -0000
@@ -248,9 +248,10 @@
 		 * @return The extracted constraint name.
 		 */
 		public String extractConstraintName(SQLException sqle) {
-			int errorCode = JDBCExceptionHelper.extractErrorCode(sqle);
+            SQLException sqlException = JDBCExceptionHelper.extractExceptionUsingErrorCode(sqle);
+			int errorCode = JDBCExceptionHelper.extractErrorCode(sqlException);
 			if ( errorCode == 1 || errorCode == 2291 || errorCode == 2292 ) {
-				return extractUsingTemplate( "constraint (", ") violated", sqle.getMessage() );
+				return extractUsingTemplate( "constraint (", ") violated", sqlException.getMessage() );
 			}
 			else if ( errorCode == 1400 ) {
 				// simple nullability constraint
Index: src/org/hibernate/exception/JDBCExceptionHelper.java
===================================================================
RCS file: /cvs/hibernate-3.2/src/org/hibernate/exception/JDBCExceptionHelper.java,v
retrieving revision 1.1
diff -u -r1.1 JDBCExceptionHelper.java
--- src/org/hibernate/exception/JDBCExceptionHelper.java	9 Jan 2007 17:24:35 -0000	1.1
+++ src/org/hibernate/exception/JDBCExceptionHelper.java	9 Jan 2007 21:33:02 -0000
@@ -50,13 +50,8 @@
 	 * @return The error code.
 	 */
 	public static int extractErrorCode(SQLException sqlException) {
-		int errorCode = sqlException.getErrorCode();
-		SQLException nested = sqlException.getNextException();
-		while ( errorCode == 0 && nested != null ) {
-			errorCode = nested.getErrorCode();
-			nested = nested.getNextException();
-		}
-		return errorCode;
+        final SQLException nested = extractExceptionUsingErrorCode(sqlException);
+        return nested == null ? 0 : nested.getErrorCode();
 	}
 
 	/**
@@ -66,13 +61,8 @@
 	 * @return The SQLState code, or null.
 	 */
 	public static String extractSqlState(SQLException sqlException) {
-		String sqlState = sqlException.getSQLState();
-		SQLException nested = sqlException.getNextException();
-		while ( sqlState == null && nested != null ) {
-			sqlState = nested.getSQLState();
-			nested = nested.getNextException();
-		}
-		return sqlState;
+        final SQLException nested = extractExceptionUsingSQLState(sqlException);
+        return nested == null ? null : nested.getSQLState();
 	}
 
 	/**
@@ -91,4 +81,40 @@
 		}
 		return sqlState.substring( 0, 2 );
 	}
+    
+    /**
+     * For a given SQLException, locates the most relevant exception based on
+     * which has an appropriate error code.
+     * 
+     * @param sqlException The exception from which to extract the most relevant exception
+     * @return The most relevant exception, or null if no exception in the chain
+     * have an error code.
+     */
+    public static SQLException extractExceptionUsingErrorCode(SQLException sqlException) {
+        do {
+            final int errorCode = sqlException.getErrorCode();
+            if(errorCode != 0)
+                return sqlException;
+            sqlException = sqlException.getNextException();
+        } while(sqlException != null);
+        return null;
+    }
+    
+    /**
+     * For a given SQLException, locates the most relevant exception based on
+     * the X/Open compliant SQLState
+     * 
+     * @param sqlException The exception from which to extract the most relevant exception
+     * @return The most relevant exception, or null if no exception in the chain
+     * have an SQLState.
+     */
+    public static SQLException extractExceptionUsingSQLState(SQLException sqlException) {
+        do {
+            final String sqlState = sqlException.getSQLState();
+            if(sqlState != null)
+                return sqlException;
+            sqlException = sqlException.getNextException();
+        } while(sqlException != null);
+        return null;
+    }
 }
